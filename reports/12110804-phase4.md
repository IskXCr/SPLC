# CS323 Compiler Project Phase 4

## SPLCC Compiler Infrastructure Initial Report

Group: 12110804 FANG Jiawei, 12110817 ZHANG Zhanwei, 12110529 CAO Zhezhen



## Test Platform

| Name         | Value                                                        |
| ------------ | ------------------------------------------------------------ |
| OS           | Ubuntu 22.04.2 LTS on Windows 10 x86_64                      |
| Bison        | GNU Bison 3.8.2                                              |
| Flex         | Flex 2.6.4                                                   |
| libbison-dev | 2:3.8.2+dfsg-1build1                                         |
| libedit-dev  | 3.1-20210910-1build1                                         |
| zlib1g-dev   | 1:1.2.11.dfsg-2ubuntu9.2                                     |
| llvm-18      | 1:18~++20240106042300+ba3ef331b456-1~exp1~20240106042415.1415 |
| clang-18     | 1:18~++20240106042300+ba3ef331b456-1~exp1~20240106042415.1415 |

Except for the LLVM-related packages, all of them are of default versions available in Ubuntu-22.04.



### Installing LLVM-18

Following the tutorial on [LLVM Debian/Ubuntu packages](https://apt.llvm.org/):

Get the installation script.

```shell
wget https://apt.llvm.org/llvm.sh
chmod +x llvm.sh
sudo ./llvm.sh 18
```

Next, install `llvm-18` (use `apt` to check installation) and `clang-18`

`sudo apt install llvm-18`

`sudo apt install clang-18`

You might want to make a symbolic link to link `clang-18` to `/usr/bin/clang` (and also for other applications including `llvm-config`).



## Project Structure

```shell
.
├── CMakeLists.txt
├── LICENSE
├── README.md
├── images
│   ├── img-1.png
│   ├── img-2.png
│   ├── img-3.png
│   ├── img-4.png
│   ├── img-5.png
│   └── img-6.png
├── misc
│   └── references
│       ├── syntax.txt
│       └── token.txt
├── modules
│   ├── libspl
│   │   ├── CMakeLists.txt
│   │   └── include
│   │       └── stdargs.h
│   ├── splc
│   │   ├── CMakeLists.txt
│   │   ├── include
│   │   │   ├── AST
│   │   │   │   ├── ASTBase.hh
│   │   │   │   ├── ASTCommons.hh
│   │   │   │   ├── ASTContext.hh
│   │   │   │   ├── ASTContextManager.hh
│   │   │   │   ├── ASTProcess.hh
│   │   │   │   ├── ASTSymbol.hh
│   │   │   │   ├── DerivedAST.hh
│   │   │   │   ├── Expr.hh
│   │   │   │   ├── SPLType.hh
│   │   │   │   ├── SPLTypeContext.hh
│   │   │   │   ├── SymbolEntry.hh
│   │   │   │   ├── TypeCheck.hh
│   │   │   │   └── Value.hh
│   │   │   ├── Analysis
│   │   │   │   └── UnusedVariable.hh
│   │   │   ├── Basic
│   │   │   │   ├── DerivedTypes.hh
│   │   │   │   ├── SPLCContext.hh
│   │   │   │   ├── Specifiers.hh
│   │   │   │   ├── Type.hh
│   │   │   │   └── Typetraits.hh
│   │   │   ├── CodeGen
│   │   │   │   ├── ASTDispatch.hh
│   │   │   │   ├── LLVMWrapper.hh
│   │   │   │   └── ObjBuilder.hh
│   │   │   ├── Core
│   │   │   │   ├── Base.hh
│   │   │   │   ├── Options.hh
│   │   │   │   ├── System.hh
│   │   │   │   ├── Utils
│   │   │   │   │   ├── CommandLineParser.hh
│   │   │   │   │   ├── ControlSequence.hh
│   │   │   │   │   ├── Location.hh
│   │   │   │   │   ├── LocationWrapper.hh
│   │   │   │   │   ├── Logging.hh
│   │   │   │   │   ├── LoggingLevel.hh
│   │   │   │   │   └── TraceType.hh
│   │   │   │   ├── Utils.hh
│   │   │   │   └── splc.hh
│   │   │   ├── IO
│   │   │   │   ├── Driver.hh
│   │   │   │   ├── IOBase.hh
│   │   │   │   ├── Preprocessor.hh
│   │   │   │   └── Scanner.hh
│   │   │   ├── SIR
│   │   │   │   ├── IR.hh
│   │   │   │   ├── IRBase.hh
│   │   │   │   ├── IRBuilder.hh
│   │   │   │   └── IROptimizer.hh
│   │   │   └── Translation
│   │   │       ├── TranslationBase.hh
│   │   │       ├── TranslationContext.hh
│   │   │       ├── TranslationContextManager.hh
│   │   │       ├── TranslationManager.hh
│   │   │       ├── TranslationOption.hh
│   │   │       ├── TranslationUnit.hh
│   │   │       └── TranslationUnitProcess.hh
│   │   └── src
│   │       ├── AST
│   │       │   ├── ASTBase.cc
│   │       │   ├── ASTBasePolymorphism.cc
│   │       │   ├── ASTBaseProcess.cc
│   │       │   ├── ASTBaseType.cc
│   │       │   ├── ASTBaseValue.cc
│   │       │   ├── ASTContext.cc
│   │       │   ├── ASTContextManager.cc
│   │       │   ├── ASTProcess.cc
│   │       │   ├── ASTSymbol.cc
│   │       │   ├── CMakeLists.txt
│   │       │   ├── DerivedAST.cc
│   │       │   ├── Expr.cc
│   │       │   ├── SymbolEntry.cc
│   │       │   ├── TypeCheck.cc
│   │       │   └── Value.cc
│   │       ├── Analysis
│   │       │   ├── CMakeLists.txt
│   │       │   └── UnusedVariable.cc
│   │       ├── Basic
│   │       │   ├── CMakeLists.txt
│   │       │   ├── Type.cc
│   │       │   └── TypeTraits.cc
│   │       ├── CodeGen
│   │       │   ├── ASTDispatch.cc
│   │       │   ├── CMakeLists.txt
│   │       │   └── ObjBuilder.cc
│   │       ├── Core
│   │       │   ├── CMakeLists.txt
│   │       │   ├── Internal.cc
│   │       │   ├── Options.cc
│   │       │   ├── System.cc
│   │       │   ├── Utils
│   │       │   │   ├── CommandLineParser.cc
│   │       │   │   └── Logging.cc
│   │       │   └── Utils.cc
│   │       ├── IO
│   │       │   ├── CMakeLists.txt
│   │       │   ├── Driver.cc
│   │       │   ├── Lexer.ll
│   │       │   ├── Parser.yy
│   │       │   └── Scanner.cc
│   │       ├── SIR
│   │       │   ├── CMakeLists.txt
│   │       │   ├── IR.cc
│   │       │   ├── IRBuilder.cc
│   │       │   └── IROptimizer.cc
│   │       ├── Translation
│   │       │   ├── CMakeLists.txt
│   │       │   ├── TranslationContext.cc
│   │       │   ├── TranslationContextManager.cc
│   │       │   ├── TranslationManager.cc
│   │       │   └── TranslationUnit.cc
│   │       └── splc.cc
│   └── ts
│       └── CMakeLists.txt
└── reports
    ├── 12110804-phase1.md
    ├── 12110804-phase1.pdf
    ├── 12110804-phase2.md
    ├── 12110804-phase2.pdf
    ├── 12110804-phase3.md
    └── 12110804-phase3.pdf

29 directories, 115 files
```



### Library Invocation and Encapsulation

**The SPL Compiler has been written into pure library form**:

- `libsplcAnalysis`: performing analysis on AST
- `libsplcAST`: encapsulating:
  -  manipulation of AST, 
  - Symbols of AST, 
  - type checking,
  - value checking, 
  - AST polymorphism support, 
  - AST processor pass (**transform passes**),
  - AST **Context management** (symbols, linkages, hierarchies)
- `libsplcBasic`: encapsulating fundamental classes of SPLC, including the singleton-based **Type** system, which supports arbitrary type and their combinations in the entire C programming language, with **pointer-based** type comparison.
- `libsplcCodeGen`: classes and functions related to **generating object code**. This is achieved by visiting our AST in `ObjBuilder`, calling the **LLVM** system to generate **LLVM IR** code.
  - **Support various target machines**:
    - MIPS
    - Default target machine of the building environment (e.g., AARCH64 for Apple M1)
    - Maybe specified later using **string**.
  - **Supports various optimization passes**.

- `libsplcCore`: classes and functions related to 
  - connecting to the underlying system (**System Wrapper**)
    - Exceptions,
    - Command-Line Parser,
    - Console Output Manager,
  - logging utilities, location tracking utilities
  - **SPLC environment options**
  - ...
- `libsplcIO`: lexer and parser used during parsing:
  - `SPLCLexer`: Provide pure lexing support based on Flex.
    - **Preprocessor support**
      - `#include`, `#define`, ...
  - `SPLCParser`: Provide **pure parser** (no side-effect on the parse itself) based on GNU Bison.
    - Syntax error analysis
- `libsplcSIR`: SUSTech IRSIM IR generation.
  - `IRBase`: base classes for IR generation, including `IRStmt`, `IRVar`, `IRFunction`, `IRProgram` and stuff. Exposing abstract interface to the user.
- `libsplcTranslation`: Providing support for **Translation Units** and **context management during translation process** (any form of translation), including:
  - `TranslationBase`: Provides basic forward declarations, including key types used in lookups during the entire translation process
  - `TranslationContext`: Support for switching translation contexts. This includes:
    - **File Management**, **Macro Management**, **Preprocessor Instructions**
  - `TranslationManager`: Support for managing the entire translation process by providing:
    - **context management**,
      - context lookup/context stack management
    - **variable lookups**,
    - **abstract IO operations**.
  - `TranslationUnit`: Support for a single translation unit, which contains the **AST** and other various translation options
  - `TranslationUnitProcess`: Support for processing translation units.

